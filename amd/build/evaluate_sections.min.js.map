{"version":3,"file":"evaluate_sections.min.js","sources":["../src/evaluate_sections.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for a user evaluating a training evaluation instance.\n *\n * @module      mod_trainingevaluation/manage_sections\n * @copyright   Pelorus Labs\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_string as getString} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\nexport const init = (trainingevaluationId, userId) => {\n    initTextInputForms(userId);\n    initSelectMenuForms(userId);\n    initDatePickerForms(userId);\n    initFinaliseButton(trainingevaluationId, userId);\n    initNewEvaluation(trainingevaluationId, userId);\n};\n\n/**\n * Initialise the select menu forms.\n *\n * @param {number} userId The user ID\n */\nconst initSelectMenuForms = (userId) => {\n    document.querySelectorAll('.mod-trainingevaluation-selectmenu-option-label').forEach(label => {\n        const itemContainer = label.closest('[data-item-id]');\n        if (!itemContainer) {\n            return;\n        }\n        const itemId = parseInt(itemContainer.dataset.itemId);\n\n        label.addEventListener('click', () => {\n            const select = document.getElementById(label.getAttribute('for'));\n            const optionId = select.dataset.optionId;\n            saveResponse(itemId, userId, optionId);\n        });\n    });\n};\n\n/**\n * Initialise the text input forms.\n *\n * @param {number} userId The user ID\n */\nconst initTextInputForms = (userId) => {\n    document.querySelectorAll('.mod-trainingevaluation-textinput-form').forEach(textarea => {\n        const itemContainer = textarea.closest('[data-item-id]');\n        if (!itemContainer) {\n            return;\n        }\n\n        const itemId = parseInt(itemContainer.dataset.itemId);\n\n        let saveTimeout = null;\n\n        // Save on input with debounce (wait for user to stop typing)\n        textarea.addEventListener('input', () => {\n            if (saveTimeout) {\n                clearTimeout(saveTimeout);\n            }\n\n            // Set a new timeout to save after no typing\n            saveTimeout = setTimeout(() => {\n                if (textarea.value !== textarea.dataset.originalValue) {\n                    saveResponse(itemId, userId, textarea.value);\n                    textarea.dataset.originalValue = textarea.value;\n                }\n            }, 500);\n        });\n\n        // Also save on blur (when field loses focus)\n        textarea.addEventListener('blur', () => {\n            // Clear the debounce timeout\n            if (saveTimeout) {\n                clearTimeout(saveTimeout);\n                saveTimeout = null;\n            }\n\n            if (textarea.value !== textarea.dataset.originalValue) {\n                saveResponse(itemId, userId, textarea.value);\n                textarea.dataset.originalValue = textarea.value;\n            }\n        });\n\n        textarea.dataset.originalValue = textarea.value;\n    });\n};\n\n/**\n * Initialise the select menu forms.\n *\n * @param {number} userId The user ID\n */\nconst initDatePickerForms = (userId) => {\n    document.querySelectorAll('.mod-trainingevaluation-datepicker-form').forEach(datepicker => {\n        const itemContainer = datepicker.closest('[data-item-id]');\n        if (!itemContainer) {\n            return;\n        }\n        const itemId = parseInt(itemContainer.dataset.itemId);\n\n        datepicker.addEventListener('change', (event) => {\n            saveResponse(itemId, userId, event.target.value);\n        });\n    });\n};\n\n/**\n * Save a response via AJAX\n *\n * @param {number} itemId The item ID\n * @param {number} userId The user ID\n * @param {string} responseData The response data\n * @returns {Promise}\n */\nconst saveResponse = async (itemId, userId, responseData) => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'mod_trainingevaluation_save_response',\n            args: {\n                itemid: itemId,\n                userid: userId,\n                response: responseData\n            }\n        }])[0];\n        if (response.error) {\n            throw new Error(response.exception);\n        }\n        showSaveFeedback(itemId, true);\n\n    } catch (error) {\n        showSaveFeedback(itemId, false);\n        Notification.exception(error);\n    }\n};\n\n/**\n * Show visual feedback when saving\n *\n * @param {number} itemId - The item ID\n * @param {boolean} success - Whether the save was successful\n */\nconst showSaveFeedback = async (itemId, success) => {\n    const itemContainer = document.querySelector(`[data-item-id=\"${itemId}\"]`);\n    if (!itemContainer) {\n        return;\n    }\n\n    const contentElement = itemContainer.querySelector('.mod-trainingevaluation-item-content');\n    if (!contentElement) {\n        return;\n    }\n\n    const existingFeedback = itemContainer.querySelector('.mod-trainingevaluation-save-feedback');\n    if (existingFeedback) {\n        existingFeedback.remove();\n    }\n\n    const feedbackSpan = document.createElement('span');\n    feedbackSpan.className =\n        'mod-trainingevaluation-save-feedback mod-trainingevaluation-save-feedback--' + (success ? 'success' : 'error');\n    feedbackSpan.textContent = '';\n    feedbackSpan.style.opacity = '1';\n\n    if (success) {\n        feedbackSpan.textContent = await getString('saved', 'mod_trainingevaluation');\n    } else {\n        feedbackSpan.textContent = await getString('errorsaving', 'mod_trainingevaluation');\n    }\n\n    contentElement.insertAdjacentElement('afterend', feedbackSpan);\n\n    // Fade out and remove after a delay\n    setTimeout(() => {\n        feedbackSpan.style.opacity = '0';\n        setTimeout(() => {\n            feedbackSpan.remove();\n        }, 500);\n    }, success ? 1000 : 2500);\n};\n\nconst initNewEvaluation = (trainingevaluationId, userId) => {\n    const newEvaluationButton = document.getElementById('mod-trainingevaluation-new-evaluation-btn');\n    if (!newEvaluationButton) {\n        return;\n    }\n\n    newEvaluationButton.addEventListener('click', async() => {\n        const confirmMessage = await getString('confirmnewevaluate', 'trainingevaluation');\n        const confirmTitle = await getString('confirm', 'core');\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: confirmTitle,\n            body: confirmMessage,\n        });\n\n        await modal.setSaveButtonText(confirmTitle);\n\n        modal.getRoot().on(ModalEvents.save, async() => {\n            try {\n                const result = await Ajax.call([{\n                    methodname: 'mod_trainingevaluation_new_evaluation',\n                    args: {\n                        wtid: trainingevaluationId,\n                        userid: userId\n                    }\n                }])[0];\n                if (result.version) {\n                    const url = new URL(window.location.href);\n                    url.searchParams.set('version', result.version);\n                    window.location.href = url.toString();\n                } else {\n                    Notification.alert('Error', result.message, 'OK');\n                }\n            } catch (error) {\n                Notification.exception(error);\n            }\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            modal.destroy();\n        });\n\n        modal.show();\n    });\n};\n\nconst initFinaliseButton = (trainingevaluationId, userId) => {\n    const finaliseButton = document.getElementById('mod-trainingevaluation-finalise-btn');\n    if (!finaliseButton) {\n        return;\n    }\n\n    finaliseButton.addEventListener('click', async() => {\n        const confirmMessage = await getString('confirmfinalise', 'trainingevaluation');\n        const confirmTitle = await getString('confirm', 'core');\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: confirmTitle,\n            body: confirmMessage,\n        });\n\n        await modal.setSaveButtonText(confirmTitle);\n\n        modal.getRoot().on(ModalEvents.save, async() => {\n            try {\n                const result = await Ajax.call([{\n                    methodname: 'mod_trainingevaluation_finalise_evaluation',\n                    args: {\n                        wtid: trainingevaluationId,\n                        userid: userId\n                    }\n                }])[0];\n                if (!result.error) {\n                    window.location.reload();\n                } else {\n                    Notification.alert('Error', result.message, 'OK');\n                }\n            } catch (error) {\n                Notification.exception(error);\n            }\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            modal.destroy();\n        });\n\n        modal.show();\n    });\n};\n"],"names":["trainingevaluationId","userId","initTextInputForms","initSelectMenuForms","initDatePickerForms","initFinaliseButton","initNewEvaluation","document","querySelectorAll","forEach","label","itemContainer","closest","itemId","parseInt","dataset","addEventListener","optionId","getElementById","getAttribute","saveResponse","textarea","saveTimeout","clearTimeout","setTimeout","value","originalValue","datepicker","event","target","async","responseData","response","Ajax","call","methodname","args","itemid","userid","error","Error","exception","showSaveFeedback","success","querySelector","contentElement","existingFeedback","remove","feedbackSpan","createElement","className","textContent","style","opacity","insertAdjacentElement","newEvaluationButton","confirmMessage","confirmTitle","modal","ModalFactory","create","type","types","SAVE_CANCEL","title","body","setSaveButtonText","getRoot","on","ModalEvents","save","result","wtid","version","url","URL","window","location","href","searchParams","set","toString","alert","message","hidden","destroy","show","finaliseButton","reload"],"mappings":"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"}